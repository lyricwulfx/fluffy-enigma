name: ABC Install
description: Install Apt, Brew, and Choco dependencies in one action.
author: LyricWulf
branding:
  icon: package
  color: orange

inputs: 
  linux:  
    description: Apt dependencies
    required: false
  macos:
    description: Brew dependencies
    required: false
  windows:
    description: Choco dependencies
    required: false
  unix:
    description: Unix-like dependencies
    required: false
  all:
    description: All dependencies
    required: false
  verbose: 
    description: Verbose output
    required: false
  no-cache:
    description: Don't use cache
    required: false
runs: 
  using: composite
  steps:
  - name: Setup | Resolve runner dependencies
    shell: bash
    id: abc-init
    run: |
      ABC_DEPS=""
      case "$RUNNER_OS" in
      Linux)
        ABC_DEPS="${{inputs.all}} ${{inputs.unix}} ${{inputs.linux}}" ;;
        # CACHE_DIRECTORY="C:\ProgramData\chocolatey\lib"$'\r\n'"%TEMP%\chocolatey" # TODO: Cache apt directory
      macOS)
        ABC_DEPS="${{inputs.all}} ${{inputs.unix}} ${{inputs.macos}}" ;;
        # TODO: Cache brew directory
        # CACHE_DIRECTORY=
      Windows)
        ABC_DEPS="${{inputs.all}} ${{inputs.windows}}" ;;
        # TODO: Cache choco directory
        # CACHE_DIRECTORY="C:\ProgramData\chocolatey\lib"$'\r\n'"%TEMP%\chocolatey" # TODO: Cache apt directory
      esac
      
      # Remove extra spaces
      ABC_DEPS=$(echo -n "${ABC_DEPS}" | xargs)
      ABC_DEPS_HASH=$(echo -n "${ABC_DEPS}" | sha256sum | awk '{print $1}')
      
      echo "::set-output name=deps::$ABC_DEPS"
      echo "::set-output name=hash::$ABC_DEPS_HASH"
      # TODO: Cache package directories
      # echo "::set-output name=cache_dirs::$CACHE_DIRECTORY"

  - name: Install | Abc
    shell: bash
    env:
      ABC_DEPS: ${{ steps.abc-init.outputs.deps }}
      ABC_OUT: ${{ (inputs.verbose == 'true' && '/dev/stdout') || '/dev/null' }}
      # DEBIAN_FRONTEND: noninteractive
    run: |
      ABC_PLATFORM_SCRIPT="./runner/$RUNNER_OS.sh"
      if [ ! -e $ABC_PLATFORM_SCRIPT ]
      then
          echo "$ABC_PLATFORM_SCRIPT is not supported by ABC"
          exit 0
      fi
      
      . runner/$RUNNER_OS/abc.sh
      exit 0
      case "${{ runner.os }}" in

      Linux)
        if [ -n "${ABC_DEPS// }" ]
        then 
          echo "Updating apt..."
          sudo apt-get update > $ABC_OUT
          echo "Installing Linux dependencies:"
          echo "  $ABC_DEPS"
          # Apt version syntax is libxyz=1.2.3, we can use a simple replace
          sudo apt-get install -y ${ABC_DEPS//@/=} > $ABC_OUT
        fi
      ;;

      macOS)
        if [ -n "${ABC_DEPS// }" ]
        then
          echo "Updating brew..."
          brew update > $ABC_OUT
          echo "Installing macOS dependencies:"
          echo "  $ABC_DEPS"
          # Brew version syntax is already libxyz@1.2.3 (same as ours)
          brew install $ABC_DEPS > $ABC_OUT
        fi
      ;;

      Windows)
        if [ -n "${ABC_DEPS// }" ]
        then
          echo "Installing Windows dependencies:"
          echo "  $ABC_DEPS"
          # Choco version syntax is libxyz --version 1.2.3
          # NOTE: CHOCO WITH VERSIONS, EACH PACKAGE MUST BE INSTALLED ONE AT A TIME
          for ABC_DEP in $ABC_DEPS
          do
            choco install -y ${ABC_DEP//@/ --version } > $ABC_OUT
          done
        fi
      ;;

      esac